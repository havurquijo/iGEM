<nav id="page-navbar" class="page-toc sticky-top navbar flex-column align-items-stretch p-3"
     style="top: 70px; visibility: hidden;">
  <h5 class="ms-2">Content</h5>
  <nav class="nav nav-pills flex-column" id="page-nav-links"></nav>
</nav>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const mainNav = document.querySelector('.fixed-top');
    const mainNavHeight = mainNav ? mainNav.offsetHeight : 56;
    const scrollOffset = mainNavHeight + 20;

    document.documentElement.style.scrollPaddingTop = scrollOffset + 'px';

    setTimeout(function () {
      const contentEl = document.getElementById('main-content');
      const navLinksContainer = document.getElementById('page-nav-links');
      const pageNavbar = document.getElementById('page-navbar');

      if (contentEl && navLinksContainer && pageNavbar) {
        // Build a structured TOC: H2 are sections; H3 anchors under each H2 are
        // treated as items belonging to that section. If a page only has H2s,
        // they are listed as top-level links.
        const sections = Array.from(contentEl.querySelectorAll('h2'));

        if (sections.length > 0) {
          pageNavbar.style.visibility = 'visible';

          sections.forEach((sec, sIdx) => {
            let secId = sec.id;
            if (!secId) { secId = 'toc-section-' + sIdx; sec.id = secId; }

            // Section link
            const sectionLink = document.createElement('a');
            sectionLink.className = 'nav-link fw-semibold';
            sectionLink.href = '#' + secId;
            sectionLink.textContent = sec.textContent.trim();
            navLinksContainer.appendChild(sectionLink);

            // Create a sub-list container for members (h3) under this section
            const subList = document.createElement('div');
            subList.className = 'nav flex-column ms-3';

            // Find h3 elements that follow this section until the next h2
            let node = sec.nextElementSibling;
            while (node && node.tagName !== 'H2') {
              if (node.tagName === 'H3') {
                let h3 = node;
                let h3Id = h3.id;
                if (!h3Id) { h3Id = secId + '-sub-' + (Math.random().toString(36).slice(2,7)); h3.id = h3Id; }

                const subLink = document.createElement('a');
                subLink.className = 'nav-link text-body-secondary small';
                subLink.href = '#' + h3Id;
                subLink.textContent = h3.textContent.trim();
                subList.appendChild(subLink);
              }
              node = node.nextElementSibling;
            }

            if (subList.children.length > 0) {
              navLinksContainer.appendChild(subList);
            }
          });

          var scrollSpy = bootstrap.ScrollSpy.getInstance(document.body);
          if (scrollSpy) { scrollSpy.refresh(); }
          else {
            new bootstrap.ScrollSpy(document.body, { target: '#page-navbar', offset: scrollOffset });
          }
        }
      }
    }, 100);
  });
</script>
